<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPA Calculator</title>
<style>
:root {
--primary: #2c5aa0;
--primary-light: #4a7ab8;
--bg: #f8f9fa;
--card-bg: #ffffff;
--text-primary: #2c3e50;
--text-secondary: #5a6c7d;
--border-color: #e1e8ed;
--input-bg: #ffffff;
--item-bg: #f1f3f4;
--item-hover: #e8eaed;
--confirmed-bg: #e8f0fe;
--shadow: rgba(0, 0, 0, 0.08);
--danger: #dc3545;
--success: #28a745;
--warning: #ffc107;
}

[data-theme="dark"] {
--primary: #5b9bd5;
--primary-light: #7ab8e8;
--bg: #1a1d21;
--card-bg: #242830;
--text-primary: #e8eaed;
--text-secondary: #9aa0a6;
--border-color: #3c4043;
--input-bg: #2d3139;
--item-bg: #2d3139;
--item-hover: #3c4043;
--confirmed-bg: #1e3a5f;
--shadow: rgba(0, 0, 0, 0.3);
--danger: #ef5350;
--success: #66bb6a;
--warning: #ffa726;
}

[data-theme="jlu"] {
--primary: #1e4d8c;
--primary-light: #2c5aa0;
--bg: #e8f4f8;
--card-bg: #ffffff;
--text-primary: #1a2951;
--text-secondary: #4a5568;
--border-color: #c5d9ed;
--input-bg: #fafcfe;
--item-bg: #f0f7ff;
--item-hover: #e1effe;
--confirmed-bg: #d4e6f7;
--shadow: rgba(30, 77, 140, 0.15);
--danger: #c53030;
--success: #276749;
--warning: #dd6b20;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
background: var(--bg);
min-height: 100vh;
padding: 20px;
display: flex;
justify-content: center;
align-items: flex-start;
color: var(--text-primary);
line-height: 1.6;
}

.container {
width: 100%;
max-width: 900px;
background: var(--card-bg);
border-radius: 12px;
box-shadow: 0 2px 12px var(--shadow);
padding: 50px 40px 40px 40px;
margin-top: 20px;
position: relative;
border: 1px solid var(--border-color);
}

.control-panel {
position: absolute;
top: 15px;
left: 15px;
display: flex;
flex-direction: row;
gap: 8px;
align-items: center;
z-index: 100;
}

.control-btn {
border: 1px solid var(--border-color);
background: var(--card-bg);
border-radius: 6px;
width: 32px;
height: 32px;
cursor: pointer;
font-size: 14px;
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
color: var(--text-secondary);
position: relative;
}

.control-btn:hover {
background: var(--item-hover);
border-color: var(--primary);
color: var(--primary);
}

.dropdown-menu {
display: none;
position: absolute;
top: 38px;
left: 0;
background: var(--card-bg);
border-radius: 8px;
padding: 6px;
box-shadow: 0 4px 12px var(--shadow);
min-width: 120px;
z-index: 101;
border: 1px solid var(--border-color);
}

.dropdown-menu.show {
display: block;
}

.dropdown-item {
padding: 8px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 13px;
transition: all 0.15s;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 8px;
}

.dropdown-item:hover {
background: var(--item-hover);
}

.dropdown-item.active {
background: var(--primary);
color: white;
}

h1 {
text-align: center;
color: var(--text-primary);
margin-bottom: 8px;
font-size: 1.8em;
font-weight: 600;
}

.subtitle {
text-align: center;
color: var(--text-secondary);
margin-bottom: 30px;
font-size: 0.9em;
}

.course-list {
margin-bottom: 20px;
}

.course-item {
display: grid;
grid-template-columns: 40px 2fr 1fr 1fr 1fr 40px;
gap: 12px;
margin-bottom: 12px;
padding: 14px;
background: var(--item-bg);
border-radius: 8px;
border: 1px solid var(--border-color);
transition: all 0.2s;
align-items: center;
}

.course-item:hover {
border-color: var(--primary-light);
box-shadow: 0 2px 8px var(--shadow);
}

.course-item.confirmed {
background: var(--confirmed-bg);
border-color: var(--primary);
}

.course-number {
font-weight: 600;
color: var(--primary);
font-size: 0.9em;
text-align: center;
background: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: 50%;
width: 28px;
height: 28px;
display: flex;
align-items: center;
justify-content: center;
}

.input-group {
display: flex;
flex-direction: column;
gap: 4px;
}

label {
font-size: 0.8em;
color: var(--text-secondary);
font-weight: 500;
}

input[type="text"],
input[type="number"] {
padding: 8px 12px;
border: 1px solid var(--border-color);
border-radius: 6px;
font-size: 14px;
transition: all 0.2s;
outline: none;
width: 100%;
background: var(--input-bg);
color: var(--text-primary);
}

input[type="text"]:focus,
input[type="number"]:focus {
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
}

[data-theme="dark"] input[type="text"]:focus,
[data-theme="dark"] input[type="number"]:focus {
box-shadow: 0 0 0 3px rgba(91, 155, 213, 0.2);
}

input.no-spinner::-webkit-outer-spin-button,
input.no-spinner::-webkit-inner-spin-button {
-webkit-appearance: none;
margin: 0;
}

input.no-spinner {
-moz-appearance: textfield;
}

.action-btn {
background: var(--primary);
color: white;
border: none;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
font-size: 0.9em;
transition: all 0.2s;
height: 36px;
width: 100%;
display: flex;
align-items: center;
justify-content: center;
}

.action-btn:hover {
background: var(--primary-light);
}

.action-btn.confirmed {
cursor: default;
opacity: 0.9;
}

.action-btn.high { background: var(--success); }
.action-btn.mid { background: var(--warning); color: #000; }
.action-btn.low { background: var(--danger); }

.delete-btn {
background: transparent;
color: var(--danger);
border: 1px solid var(--danger);
width: 32px;
height: 32px;
border-radius: 6px;
cursor: pointer;
font-size: 18px;
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
}

.delete-btn:hover {
background: var(--danger);
color: white;
}

.button-group {
display: flex;
gap: 12px;
margin-top: 24px;
flex-wrap: wrap;
}

.main-btn {
flex: 1;
min-width: 140px;
padding: 12px 24px;
border: none;
border-radius: 8px;
font-size: 15px;
font-weight: 500;
cursor: pointer;
transition: all 0.2s;
font-family: inherit;
}

.add-btn {
background: var(--primary);
color: white;
}

.add-btn:hover {
background: var(--primary-light);
box-shadow: 0 2px 8px var(--shadow);
}

.calc-btn {
background: var(--success);
color: white;
}

.calc-btn:hover {
opacity: 0.9;
box-shadow: 0 2px 8px var(--shadow);
}

.result-section {
margin-top: 32px;
padding: 24px;
background: var(--item-bg);
border-radius: 12px;
text-align: center;
display: none;
border: 1px solid var(--border-color);
}

.result-section.show { display: block; }

.result-title {
font-size: 1.1em;
color: var(--text-secondary);
margin-bottom: 12px;
font-weight: 500;
}

.gpa-value {
font-size: 3em;
font-weight: 700;
color: var(--primary);
margin: 8px 0;
line-height: 1.2;
}

.result-details {
display: flex;
justify-content: center;
gap: 32px;
margin-top: 16px;
flex-wrap: wrap;
}

.detail-item {
background: var(--card-bg);
padding: 12px 24px;
border-radius: 8px;
border: 1px solid var(--border-color);
min-width: 120px;
}

.detail-label {
font-size: 0.85em;
color: var(--text-secondary);
margin-bottom: 4px;
}

.detail-value {
font-size: 1.2em;
font-weight: 600;
color: var(--text-primary);
}

.empty-state {
text-align: center;
padding: 40px;
color: var(--text-secondary);
background: var(--item-bg);
border-radius: 8px;
border: 1px dashed var(--border-color);
font-size: 0.95em;
}

.grade-scale-container {
margin-top: 24px;
background: var(--item-bg);
border-radius: 8px;
border: 1px solid var(--border-color);
overflow: hidden;
}

.grade-scale-header {
background: var(--primary);
color: white;
padding: 12px 16px;
cursor: pointer;
display: flex;
justify-content: space-between;
align-items: center;
font-weight: 500;
font-size: 1em;
transition: opacity 0.2s;
}

.grade-scale-header:hover {
opacity: 0.95;
}

.grade-scale-icon {
font-size: 0.8em;
transition: transform 0.3s;
}

.grade-scale-container.expanded .grade-scale-icon {
transform: rotate(180deg);
}

.grade-scale-content {
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease;
padding: 0 16px;
}

.grade-scale-container.expanded .grade-scale-content {
max-height: 500px;
padding: 16px;
}

.scale-cards-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
gap: 8px;
}

.scale-card {
background: var(--card-bg);
border: 1px solid var(--border-color);
border-radius: 6px;
padding: 10px;
text-align: center;
font-size: 0.9em;
}

.scale-card-range {
font-size: 0.85em;
color: var(--text-secondary);
margin-bottom: 4px;
}

.scale-card-value {
font-size: 1.1em;
font-weight: 600;
color: var(--primary);
}

@media (max-width: 768px) {
body { padding: 10px; }
.container { padding: 50px 20px 20px 20px; }
.control-panel { top: 12px; left: 12px; }
.course-item {
grid-template-columns: 36px 1fr 36px;
grid-template-rows: auto auto auto auto;
gap: 10px;
padding: 16px;
}
.course-number { grid-column: 1; grid-row: 1; width: 28px; height: 28px; font-size: 0.85em; }
.delete-btn { grid-column: 3; grid-row: 1; width: 28px; height: 28px; font-size: 16px; }
.course-item .input-group:nth-of-type(1) { grid-column: 2; grid-row: 1; }
.course-item .input-group:nth-of-type(2) { grid-column: 1 / 4; grid-row: 2; }
.course-item .input-group:nth-of-type(3) { grid-column: 1 / 4; grid-row: 3; }
.action-btn { grid-column: 1 / 4; grid-row: 4; height: 40px; }
h1 { font-size: 1.5em; }
.gpa-value { font-size: 2.5em; }
.scale-cards-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
}

.error-shake { animation: shake 0.4s; border-color: var(--danger) !important; }

@keyframes shake {
0%, 100% { transform: translateX(0); }
25% { transform: translateX(-8px); }
75% { transform: translateX(8px); }
}

.chart-section {
margin-top: 32px;
padding: 24px;
background: var(--card-bg);
border-radius: 12px;
border: 1px solid var(--border-color);
display: none;
}

.chart-section.show { display: block; }

.chart-title {
text-align: center;
font-size: 1.1em;
color: var(--text-primary);
margin-bottom: 16px;
font-weight: 600;
}

.chart-wrapper {
position: relative;
width: 100%;
max-width: 500px;
margin: 0 auto;
height: 300px;
}

#contributionChart { width: 100%; height: 100%; }

.chart-tooltip {
position: absolute;
background: var(--text-primary);
color: var(--bg);
padding: 8px 12px;
border-radius: 6px;
font-size: 12px;
pointer-events: none;
opacity: 0;
transition: opacity 0.2s;
z-index: 10;
}

.chart-tooltip.show { opacity: 1; }

.legend {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 8px;
margin-top: 16px;
padding-top: 16px;
border-top: 1px solid var(--border-color);
}

.legend-item {
display: flex;
align-items: center;
gap: 6px;
font-size: 0.8em;
color: var(--text-secondary);
background: var(--item-bg);
padding: 4px 8px;
border-radius: 4px;
}

.legend-color {
width: 10px;
height: 10px;
border-radius: 2px;
}

.toast {
position: fixed;
bottom: 24px;
left: 50%;
transform: translateX(-50%) translateY(100px);
background: var(--text-primary);
color: var(--bg);
padding: 12px 24px;
border-radius: 6px;
font-weight: 500;
box-shadow: 0 4px 12px var(--shadow);
opacity: 0;
transition: all 0.3s;
z-index: 1000;
font-size: 0.9em;
}

.toast.show {
opacity: 1;
transform: translateX(-50%) translateY(0);
}

.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
z-index: 1000;
justify-content: center;
align-items: center;
backdrop-filter: blur(4px);
}

.modal-overlay.show { display: flex; }

.modal-content {
background: var(--card-bg);
border-radius: 12px;
padding: 24px;
width: 90%;
max-width: 500px;
max-height: 80vh;
overflow-y: auto;
border: 1px solid var(--border-color);
box-shadow: 0 4px 20px var(--shadow);
}

.modal-header {
font-size: 1.3em;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 8px;
}

.modal-subtitle {
color: var(--text-secondary);
font-size: 0.85em;
margin-bottom: 16px;
}

.scale-row {
display: grid;
grid-template-columns: 1fr 1fr 1fr auto;
gap: 8px;
margin-bottom: 10px;
align-items: center;
}

.scale-row input {
padding: 8px;
border: 1px solid var(--border-color);
border-radius: 6px;
font-size: 14px;
background: var(--input-bg);
color: var(--text-primary);
width: 100%;
}

.remove-row-btn {
background: transparent;
color: var(--danger);
border: 1px solid var(--danger);
width: 28px;
height: 28px;
border-radius: 6px;
cursor: pointer;
font-size: 16px;
display: flex;
align-items: center;
justify-content: center;
}

.remove-row-btn:hover {
background: var(--danger);
color: white;
}

.add-row-btn {
background: var(--success);
color: white;
border: none;
padding: 10px;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
font-size: 13px;
margin: 12px 0;
width: 100%;
}

.modal-actions {
display: flex;
gap: 10px;
margin-top: 16px;
}

.modal-btn {
flex: 1;
padding: 10px 20px;
border: none;
border-radius: 6px;
font-weight: 500;
font-size: 14px;
cursor: pointer;
}

.modal-btn-primary {
background: var(--primary);
color: white;
}

.modal-btn-secondary {
background: var(--item-bg);
color: var(--text-primary);
border: 1px solid var(--border-color);
}

@media (max-width: 768px) {
.modal-content { padding: 20px; width: 95%; }
.scale-row { gap: 6px; }
.scale-row input { padding: 6px; font-size: 13px; }
}
</style>
</head>
<body>
<div class="container">
<div class="control-panel">
<button class="control-btn" onclick="window.location.href='/JLU-Toolkit/index.html'" title="返回首页">←</button>
<button class="control-btn" id="themeBtn" onclick="toggleDropdown('themeDropdown')" title="切换主题">☀</button>
<div class="dropdown-menu" id="themeDropdown"></div>
<button class="control-btn" id="langBtn" onclick="toggleDropdown('langDropdown')" title="切换语言">文</button>
<div class="dropdown-menu" id="langDropdown"></div>
<button class="control-btn" id="modeBtn" onclick="toggleDropdown('modeDropdown')" title="GPA模式">◈</button>
<div class="dropdown-menu" id="modeDropdown"></div>
</div>

<h1 id="title">综合绩点计算器</h1>
<p class="subtitle" id="subtitle">输入课程信息，确认后计算加权平均绩点 GPA</p>

<div id="courseList" class="course-list">
<div class="empty-state" id="emptyState">
<span id="emptyText">暂无课程，点击下方"新增课程"按钮添加</span>
</div>
</div>

<div class="button-group">
<button class="main-btn add-btn" onclick="addCourse()" id="addBtnText">新增课程</button>
<button class="main-btn calc-btn" onclick="calculateGPA()" id="calcBtnText">开始计算</button>
</div>

<div id="resultSection" class="result-section">
<div class="result-title" id="resultTitle">加权平均绩点</div>
<!-- 修改：初始显示为 0.00000 -->
<div class="gpa-value" id="gpaValue">0.00000</div>
<div class="result-details">
<div class="detail-item">
<div class="detail-label" id="totalCoursesLabel">课程数</div>
<div class="detail-value" id="totalCourses">0</div>
</div>
<div class="detail-item">
<div class="detail-label" id="totalCreditsLabel">总学分</div>
<div class="detail-value" id="totalCredits">0</div>
</div>
</div>
</div>

<div id="chartSection" class="chart-section">
<div class="chart-title" id="chartTitle">各课程贡献占比</div>
<div class="chart-wrapper" id="chartWrapper">
<canvas id="contributionChart"></canvas>
<div class="chart-tooltip" id="chartTooltip"></div>
</div>
<div class="legend" id="chartLegend"></div>
</div>

<div class="grade-scale-container" id="gradeScaleContainer">
<div class="grade-scale-header" onclick="toggleGradeScale()">
<span id="scaleHeaderText">绩点对照表</span>
<span class="grade-scale-icon">▼</span>
</div>
<div class="grade-scale-content" id="gradeScaleContent">
<div class="scale-cards-grid" id="scaleCardsGrid"></div>
</div>
</div>
</div>

<div class="modal-overlay" id="customScaleModal">
<div class="modal-content">
<div class="modal-header" id="modalTitle">自定义绩点规则</div>
<div class="modal-subtitle" id="modalSubtitle">设置分数段与绩点对应关系（范围不可重叠）</div>
<div id="scaleRowsContainer"></div>
<button class="add-row-btn" onclick="addScaleRow()" id="addRowText">+ 添加规则</button>
<div class="modal-actions">
<button class="modal-btn modal-btn-secondary" onclick="closeCustomScaleModal()" id="cancelBtn">取消</button>
<button class="modal-btn modal-btn-primary" onclick="saveCustomScale()" id="confirmBtn">确认使用</button>
</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
let courseCount = 0;
let currentTheme = 'default';
let currentLang = 'zh-CN';
let currentMode = 'jida';
let courseChartData = [];
let customScaleData = [];
let previousMode = null;

const colors = [
'#2c5aa0', '#28a745', '#dc3545', '#5b9bd5', '#ffc107', 
'#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#17a2b8'
];

const themes = [
{ id: 'default', name: '极光白', icon: '☀' },
{ id: 'dark', name: '暗夜黑', icon: '☾' },
{ id: 'jlu', name: '吉大蓝', icon: '▪' }
];

const languages = [
{ code: 'zh-CN', name: '简体中文' },
{ code: 'zh-TW', name: '繁體中文' },
{ code: 'en', name: 'English' },
{ code: 'ja', name: '日本語' },
{ code: 'ko', name: '한국어' },
{ code: 'de', name: 'Deutsch' }
];

const modes = [
{ id: 'jida', name: '吉大模式' },
{ id: 'cuc', name: '中传模式' },
{ id: 'custom', name: '自定义' }
];

const cucData = [
{score: 60, gp: 1.00}, {score: 60.5, gp: 1.07}, {score: 61, gp: 1.15}, {score: 61.5, gp: 1.22},
{score: 62, gp: 1.29}, {score: 62.5, gp: 1.36}, {score: 63, gp: 1.43}, {score: 63.5, gp: 1.50},
{score: 64, gp: 1.57}, {score: 64.5, gp: 1.64}, {score: 65, gp: 1.70}, {score: 65.5, gp: 1.77},
{score: 66, gp: 1.83}, {score: 66.5, gp: 1.90}, {score: 67, gp: 1.96}, {score: 67.5, gp: 2.02},
{score: 68, gp: 2.08}, {score: 68.5, gp: 2.14}, {score: 69, gp: 2.20}, {score: 69.5, gp: 2.26},
{score: 70, gp: 2.31}, {score: 70.5, gp: 2.37}, {score: 71, gp: 2.42}, {score: 71.5, gp: 2.48},
{score: 72, gp: 2.53}, {score: 72.5, gp: 2.58}, {score: 73, gp: 2.63}, {score: 73.5, gp: 2.68},
{score: 74, gp: 2.73}, {score: 74.5, gp: 2.78}, {score: 75, gp: 2.83}, {score: 75.5, gp: 2.87},
{score: 76, gp: 2.92}, {score: 76.5, gp: 2.96}, {score: 77, gp: 3.01}, {score: 77.5, gp: 3.05},
{score: 78, gp: 3.09}, {score: 78.5, gp: 3.13}, {score: 79, gp: 3.17}, {score: 79.5, gp: 3.21},
{score: 80, gp: 3.25}, {score: 80.5, gp: 3.29}, {score: 81, gp: 3.32}, {score: 81.5, gp: 3.36},
{score: 82, gp: 3.39}, {score: 82.5, gp: 3.43}, {score: 83, gp: 3.46}, {score: 83.5, gp: 3.49},
{score: 84, gp: 3.52}, {score: 84.5, gp: 3.55}, {score: 85, gp: 3.58}, {score: 85.5, gp: 3.61},
{score: 86, gp: 3.63}, {score: 86.5, gp: 3.66}, {score: 87, gp: 3.68}, {score: 87.5, gp: 3.71},
{score: 88, gp: 3.73}, {score: 88.5, gp: 3.75}, {score: 89, gp: 3.77}, {score: 89.5, gp: 3.79},
{score: 90, gp: 3.81}, {score: 90.5, gp: 3.83}, {score: 91, gp: 3.85}, {score: 91.5, gp: 3.86},
{score: 92, gp: 3.88}, {score: 92.5, gp: 3.89}, {score: 93, gp: 3.91}, {score: 93.5, gp: 3.92},
{score: 94, gp: 3.93}, {score: 94.5, gp: 3.94}, {score: 95, gp: 3.95}, {score: 95.5, gp: 3.96},
{score: 96, gp: 3.97}, {score: 96.5, gp: 3.98}, {score: 97, gp: 3.98}, {score: 97.5, gp: 3.99},
{score: 98, gp: 3.99}, {score: 98.5, gp: 4.00}, {score: 99, gp: 4.00}, {score: 99.5, gp: 4.00},
{score: 100, gp: 4.00}
];

const translations = {
'zh-CN': {
title: '综合绩点计算器',
subtitle: '输入课程信息，确认后计算加权平均绩点 GPA',
empty: '暂无课程，点击下方"新增课程"按钮添加',
courseName: '课程名称',
courseNamePlaceholder: '例如：高等数学',
score: '成绩',
credit: '学分',
confirm: '确认',
delete: '删除',
addCourse: '新增课程',
calc: '开始计算',
resultTitle: '加权平均绩点',
totalCourses: '课程数',
totalCredits: '总学分',
chartTitle: '各课程贡献占比',
scaleTitle: '绩点对照表',
scaleRange: '分数段',
below60: '60以下',
themes: ['极光白', '暗夜黑', '吉大蓝'],
modes: ['吉大模式', '中传模式', '自定义'],
modeNames: { jida: '吉大模式', cuc: '中传模式', custom: '自定义' },
scaleClickToExpand: '点击查看详情',
controls: { theme: '主题', language: '语言', mode: 'GPA模式' },
modal: {
title: '自定义绩点规则',
subtitle: '设置分数段与绩点对应关系（范围不可重叠）',
minScore: '最低分',
maxScore: '最高分',
gradePoint: '绩点',
addRow: '添加规则',
cancel: '取消',
confirm: '确认使用',
validationError: '请填写完整的分数段和绩点',
overlapError: '分数段不能重叠',
rangeError: '最高分必须大于最低分',
duplicateError: '存在重复或冲突的分数范围'
},
toast: {
noCourse: '请至少添加一门课程',
confirmAll: '请确认所有课程信息',
invalidScore: '请输入有效的成绩（0-100）',
invalidCredit: '请输入有效的学分',
noName: '请输入课程名称',
zeroCredit: '总学分不能为0',
confirmed: '课程已确认',
modeSwitch: '已切换至',
excellent: '成绩优秀，继续保持！',
good: '成绩良好，还有提升空间',
average: '成绩尚可，继续努力',
improve: '继续加油，相信你一定能行',
customScaleSet: '已应用自定义规则'
},
chart: { contribution: '贡献度', weighted: '学分×绩点', name: '课程', gp: '绩点', credits: '学分' }
},
'zh-TW': {
title: '綜合績點計算器',
subtitle: '輸入課程資訊，確認後計算加權平均績點 GPA',
empty: '暫無課程，點擊下方"新增課程"按鈕添加',
courseName: '課程名稱',
courseNamePlaceholder: '例如：高等數學',
score: '成績',
credit: '學分',
confirm: '確認',
delete: '刪除',
addCourse: '新增課程',
calc: '開始計算',
resultTitle: '加權平均績點',
totalCourses: '課程數',
totalCredits: '總學分',
chartTitle: '各課程貢獻佔比',
scaleTitle: '績點對照表',
scaleRange: '分數段',
below60: '60以下',
themes: ['極光白', '暗夜黑', '吉大藍'],
modes: ['吉大模式', '中傳模式', '自定義'],
modeNames: { jida: '吉大模式', cuc: '中傳模式', custom: '自定義' },
scaleClickToExpand: '點擊查看詳情',
controls: { theme: '主題', language: '語言', mode: 'GPA模式' },
modal: {
title: '自定義績點規則',
subtitle: '設置分數段與績點對應關係（範圍不可重疊）',
minScore: '最低分',
maxScore: '最高分',
gradePoint: '績點',
addRow: '添加規則',
cancel: '取消',
confirm: '確認使用',
validationError: '請填寫完整的分數段和績點',
overlapError: '分數段不能重疊',
rangeError: '最高分必須大於最低分',
duplicateError: '存在重複或衝突的分數範圍'
},
toast: {
noCourse: '請至少添加一門課程',
confirmAll: '請確認所有課程資訊',
invalidScore: '請輸入有效的成績（0-100）',
invalidCredit: '請輸入有效的學分',
noName: '請輸入課程名稱',
zeroCredit: '總學分不能為0',
confirmed: '課程已確認',
modeSwitch: '已切換至',
excellent: '成績優秀，繼續保持！',
good: '成績良好，還有提升空間',
average: '成績尚可，繼續努力',
improve: '繼續加油，相信你一定能行',
customScaleSet: '已應用自定義規則'
},
chart: { contribution: '貢獻度', weighted: '學分×績點', name: '課程', gp: '績點', credits: '學分' }
},
'en': {
title: 'GPA Calculator',
subtitle: 'Enter course information to calculate weighted GPA',
empty: 'No courses yet. Click "Add Course" to start',
courseName: 'Course Name',
courseNamePlaceholder: 'e.g. Calculus',
score: 'Score',
credit: 'Credits',
confirm: 'Confirm',
delete: 'Delete',
addCourse: 'Add Course',
calc: 'Calculate',
resultTitle: 'Weighted GPA',
totalCourses: 'Courses',
totalCredits: 'Total Credits',
chartTitle: 'Course Contribution',
scaleTitle: 'Grade Scale',
scaleRange: 'Score Range',
below60: '<60',
themes: ['Aurora White', 'Dark Night', 'JLU Blue'],
modes: ['JLU Mode', 'CUC Mode', 'Custom'],
modeNames: { jida: 'JLU Mode', cuc: 'CUC Mode', custom: 'Custom' },
scaleClickToExpand: 'Click for details',
controls: { theme: 'Theme', language: 'Language', mode: 'GPA Mode' },
modal: {
title: 'Custom GPA Rules',
subtitle: 'Set score ranges and corresponding GPA (no overlaps)',
minScore: 'Min Score',
maxScore: 'Max Score',
gradePoint: 'GPA',
addRow: 'Add Rule',
cancel: 'Cancel',
confirm: 'Apply',
validationError: 'Please fill in all score ranges and GPA values',
overlapError: 'Score ranges cannot overlap',
rangeError: 'Max score must be greater than min score',
duplicateError: 'Duplicate or conflicting score ranges exist'
},
toast: {
noCourse: 'Please add at least one course',
confirmAll: 'Please confirm all courses',
invalidScore: 'Please enter valid score (0-100)',
invalidCredit: 'Please enter valid credits',
noName: 'Please enter course name',
zeroCredit: 'Total credits cannot be 0',
confirmed: 'Course confirmed',
modeSwitch: 'Switched to',
excellent: 'Excellent! Keep up the good work!',
good: 'Good job! Room for improvement',
average: 'Not bad! Keep working hard',
improve: 'Keep trying, you can do it',
customScaleSet: 'Custom rules applied'
},
chart: { contribution: 'Contribution', weighted: 'Credits×GPA', name: 'Course', gp: 'GPA', credits: 'Credits' }
},
'ja': {
title: 'GPA計算機',
subtitle: '科目情報を入力して加重平均GPAを計算',
empty: '科目がありません。「科目を追加」をクリック',
courseName: '科目名',
courseNamePlaceholder: '例：微積分学',
score: '成績',
credit: '単位',
confirm: '確認',
delete: '削除',
addCourse: '科目を追加',
calc: '計算する',
resultTitle: '加重平均GPA',
totalCourses: '科目数',
totalCredits: '合計単位',
chartTitle: '科目別貢献度',
scaleTitle: '評価基準',
scaleRange: '得点範囲',
below60: '60未満',
themes: ['オーロラホワイト', 'ダークナイト', 'JLUブルー'],
modes: ['JLUモード', 'CUCモード', 'カスタム'],
modeNames: { jida: 'JLUモード', cuc: 'CUCモード', custom: 'カスタム' },
scaleClickToExpand: 'クリックして詳細を表示',
controls: { theme: 'テーマ', language: '言語', mode: 'GPAモード' },
modal: {
title: 'カスタムGPAルール',
subtitle: '得点範囲とGPAの対応を設定（重複不可）',
minScore: '最低得点',
maxScore: '最高得点',
gradePoint: 'GPA',
addRow: 'ルール追加',
cancel: 'キャンセル',
confirm: '適用',
validationError: 'すべての得点範囲とGPAを入力してください',
overlapError: '得点範囲が重複しています',
rangeError: '最高得点は最低得点より大きくなければなりません',
duplicateError: '重複または競合する得点範囲があります'
},
toast: {
noCourse: '少なくとも1つの科目を追加してください',
confirmAll: 'すべての科目を確認してください',
invalidScore: '有効な成績を入力してください（0-100）',
invalidCredit: '有効な単位数を入力してください',
noName: '科目名を入力してください',
zeroCredit: '合計単位数は0にできません',
confirmed: '科目が確認されました',
modeSwitch: '切り替え完了：',
excellent: '優秀です！この調子で頑張りましょう！',
good: '良好です！まだ伸びしろがあります',
average: 'がんばりましょう！',
improve: '頑張り続ければ必ずできます',
customScaleSet: 'カスタムルールを適用しました'
},
chart: { contribution: '貢献度', weighted: '単位×GPA', name: '科目', gp: 'GPA', credits: '単位' }
},
'ko': {
title: '학점계산기',
subtitle: '과목 정보를 입력하여 가중 평균 GPA 계산',
empty: '과목이 없습니다. "과목 추가"를 클릭하세요',
courseName: '과목명',
courseNamePlaceholder: '예: 미적분학',
score: '성적',
credit: '학점',
confirm: '확인',
delete: '삭제',
addCourse: '과목 추가',
calc: '계산하기',
resultTitle: '가중 평균 GPA',
totalCourses: '과목 수',
totalCredits: '총 학점',
chartTitle: '과목별 기여도',
scaleTitle: '학점 기준표',
scaleRange: '점수 구간',
below60: '60미만',
themes: ['오로라 화이트', '다크 나이트', 'JLU 블루'],
modes: ['JLU 모드', 'CUC 모드', '사용자 정의'],
modeNames: { jida: 'JLU 모드', cuc: 'CUC 모드', custom: '사용자 정의' },
scaleClickToExpand: '클릭하여 상세 보기',
controls: { theme: '테마', language: '언어', mode: 'GPA 모드' },
modal: {
title: '사용자 정의 학점 규칙',
subtitle: '점수 범위와 학점 설정 (중복 불가)',
minScore: '최저 점수',
maxScore: '최고 점수',
gradePoint: '학점',
addRow: '규칙 추가',
cancel: '취소',
confirm: '적용',
validationError: '모든 점수 범위와 학점을 입력하세요',
overlapError: '점수 범위가 중복됩니다',
rangeError: '최고 점수는 최저 점수보다 커야 합니다',
duplicateError: '중복되거나 충돌하는 점수 범위가 있습니다'
},
toast: {
noCourse: '최소 한 개의 과목을 추가하세요',
confirmAll: '모든 과목을 확인하세요',
invalidScore: '유효한 성적을 입력하세요 (0-100)',
invalidCredit: '유효한 학점을 입력하세요',
noName: '과목명을 입력하세요',
zeroCredit: '총 학점은 0이 될 수 없습니다',
confirmed: '과목이 확인되었습니다',
modeSwitch: '변경 완료: ',
excellent: '훌륭합니다! 계속 유지하세요!',
good: '잘했습니다! 발전의 여지가 있습니다',
average: '계속 노력하세요!',
improve: '계속 노력하면 반드시 성공합니다',
customScaleSet: '사용자 정의 규칙이 적용되었습니다'
},
chart: { contribution: '기여도', weighted: '학점×GPA', name: '과목', gp: 'GPA', credits: '학점' }
},
'de': {
title: 'GPA Rechner',
subtitle: 'Kursdaten eingeben, gewichteten GPA berechnen',
empty: 'Keine Kurse. "Kurs hinzufügen" klicken',
courseName: 'Kursname',
courseNamePlaceholder: 'z.B. Analysis',
score: 'Note',
credit: 'Credits',
confirm: 'Bestätigen',
delete: 'Löschen',
addCourse: 'Kurs hinzufügen',
calc: 'Berechnen',
resultTitle: 'Gewichteter GPA',
totalCourses: 'Kurse',
totalCredits: 'Credits gesamt',
chartTitle: 'Kursbeitrag',
scaleTitle: 'Notenskala',
scaleRange: 'Notenbereich',
below60: '<60',
themes: ['Aurora Weiß', 'Dunkle Nacht', 'JLU Blau'],
modes: ['JLU Modus', 'CUC Modus', 'Benutzerdefiniert'],
modeNames: { jida: 'JLU Modus', cuc: 'CUC Modus', custom: 'Benutzerdefiniert' },
scaleClickToExpand: 'Details anzeigen',
controls: { theme: 'Thema', language: 'Sprache', mode: 'GPA Modus' },
modal: {
title: 'Benutzerdefinierte Regeln',
subtitle: 'Punktbereiche und GPA-Werte festlegen (keine Überschneidungen)',
minScore: 'Min. Punkte',
maxScore: 'Max. Punkte',
gradePoint: 'GPA',
addRow: 'Regel hinzufügen',
cancel: 'Abbrechen',
confirm: 'Anwenden',
validationError: 'Bitte alle Punktbereiche und GPA-Werte ausfüllen',
overlapError: 'Punktbereiche dürfen sich nicht überschneiden',
rangeError: 'Max. Punkte müssen größer als Min. Punkte sein',
duplicateError: 'Doppelte oder konfliktierende Bereiche vorhanden'
},
toast: {
noCourse: 'Bitte mindestens einen Kurs hinzufügen',
confirmAll: 'Bitte alle Kurse bestätigen',
invalidScore: 'Bitte gültige Note eingeben (0-100)',
invalidCredit: 'Bitte gültige Credits eingeben',
noName: 'Bitte Kursnamen eingeben',
zeroCredit: 'Gesamtcredits dürfen nicht 0 sein',
confirmed: 'Kurs bestätigt',
modeSwitch: 'Gewechselt zu: ',
excellent: 'Hervorragend! Weiter so!',
good: 'Sehr gut! Noch Raum zur Verbesserung',
average: 'Nicht schlecht! Weiter arbeiten',
improve: 'Weiter versuchen, Sie schaffen das',
customScaleSet: 'Benutzerdefinierte Regeln angewendet'
},
chart: { contribution: 'Beitrag', weighted: 'Credits×GPA', name: 'Kurs', gp: 'GPA', credits: 'Credits' }
}
};

function calculateGradePoint(score) {
if (currentMode === 'jida') {
if (score >= 90) return 4.0;
if (score >= 87) return 3.7;
if (score >= 84) return 3.3;
if (score >= 80) return 3.0;
if (score >= 77) return 2.7;
if (score >= 74) return 2.3;
if (score >= 70) return 2.0;
if (score >= 67) return 1.7;
if (score >= 64) return 1.3;
if (score >= 60) return 1.0;
return 0.0;
} else if (currentMode === 'custom') {
if (customScaleData.length === 0) return 0.0;
const sortedRules = [...customScaleData].sort((a, b) => b.min - a.min);
for (let rule of sortedRules) {
if (score >= rule.min && score <= rule.max) {
return rule.gp;
}
}
return 0.0;
} else {
if (score < 60) return 0.0;
if (score >= 100) return 4.0;
const index = cucData.findIndex(item => item.score >= score);
if (index === -1) return 4.0;
return cucData[index].gp;
}
}

function renderGradeScaleCards() {
const grid = document.getElementById('scaleCardsGrid');
const t = translations[currentLang];
grid.innerHTML = '';
if (currentMode === 'jida') {
const ranges = [
{ range: '90-100', gp: '4.0' },
{ range: '87-89', gp: '3.7' },
{ range: '84-86', gp: '3.3' },
{ range: '80-83', gp: '3.0' },
{ range: '77-79', gp: '2.7' },
{ range: '74-76', gp: '2.3' },
{ range: '70-73', gp: '2.0' },
{ range: '67-69', gp: '1.7' },
{ range: '64-66', gp: '1.3' },
{ range: '60-63', gp: '1.0' },
{ range: t.below60, gp: '0.0' }
];
ranges.forEach(item => {
const card = document.createElement('div');
card.className = 'scale-card';
card.innerHTML = `
<div class="scale-card-range">${item.range}</div>
<div class="scale-card-value">${item.gp}</div>
`;
grid.appendChild(card);
});
} else if (currentMode === 'custom') {
if (customScaleData.length === 0) {
grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 20px;">${t.modal.subtitle}</div>`;
} else {
const sortedRules = [...customScaleData].sort((a, b) => a.min - b.min);
sortedRules.forEach(item => {
const card = document.createElement('div');
card.className = 'scale-card';
card.innerHTML = `
<div class="scale-card-range">${item.min}-${item.max}</div>
<div class="scale-card-value">${item.gp.toFixed(1)}</div>
`;
grid.appendChild(card);
});
const minScore = Math.min(...customScaleData.map(r => r.min));
if (minScore > 0) {
const card = document.createElement('div');
card.className = 'scale-card';
card.style.opacity = '0.7';
card.innerHTML = `
<div class="scale-card-range">${t.below60 || '<' + minScore}</div>
<div class="scale-card-value">0.0</div>
`;
grid.appendChild(card);
}
}
} else {
cucData.forEach(item => {
const card = document.createElement('div');
card.className = 'scale-card';
card.innerHTML = `
<div class="scale-card-range">${item.score}</div>
<div class="scale-card-value">${item.gp.toFixed(2)}</div>
`;
grid.appendChild(card);
});
}
}

function toggleGradeScale() {
const container = document.getElementById('gradeScaleContainer');
container.classList.toggle('expanded');
}

function openCustomScaleModal() {
const modal = document.getElementById('customScaleModal');
const t = translations[currentLang];
document.getElementById('modalTitle').textContent = t.modal.title;
document.getElementById('modalSubtitle').textContent = t.modal.subtitle;
document.getElementById('addRowText').textContent = t.modal.addRow;
document.getElementById('cancelBtn').textContent = t.modal.cancel;
document.getElementById('confirmBtn').textContent = t.modal.confirm;
const container = document.getElementById('scaleRowsContainer');
container.innerHTML = '';
if (customScaleData.length > 0) {
customScaleData.forEach((rule) => {
addScaleRow(rule.min, rule.max, rule.gp);
});
} else {
addScaleRow();
addScaleRow();
addScaleRow();
}
modal.classList.add('show');
}

function closeCustomScaleModal() {
document.getElementById('customScaleModal').classList.remove('show');
const t = translations[currentLang];
if (customScaleData.length === 0 && previousMode && previousMode !== 'custom') {
currentMode = previousMode;
renderDropdowns();
document.getElementById('scaleHeaderText').textContent = `${t.scaleTitle} (${t.modeNames[currentMode]})`;
showToast(`${t.toast.modeSwitch} ${t.modeNames[currentMode]}`);
}
}

function addScaleRow(min = '', max = '', gp = '') {
const container = document.getElementById('scaleRowsContainer');
const t = translations[currentLang];
const rowId = 'scale-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
const row = document.createElement('div');
row.className = 'scale-row';
row.id = rowId;
row.innerHTML = `
<input type="number" placeholder="${t.modal.minScore}" min="0" max="100" value="${min}" class="min-input">
<input type="number" placeholder="${t.modal.maxScore}" min="0" max="100" value="${max}" class="max-input">
<input type="number" placeholder="${t.modal.gradePoint}" min="0" max="5" step="0.1" value="${gp}" class="gp-input">
<button class="remove-row-btn" onclick="removeScaleRow('${rowId}')" title="Delete">×</button>
`;
container.appendChild(row);
}

function removeScaleRow(rowId) {
const row = document.getElementById(rowId);
if (row) {
row.remove();
}
}

function saveCustomScale() {
const rows = document.querySelectorAll('.scale-row');
const t = translations[currentLang];
const newRules = [];
for (let row of rows) {
const min = parseFloat(row.querySelector('.min-input').value);
const max = parseFloat(row.querySelector('.max-input').value);
const gp = parseFloat(row.querySelector('.gp-input').value);
if (isNaN(min) && isNaN(max) && isNaN(gp)) continue;
if (isNaN(min) || isNaN(max) || isNaN(gp)) {
showToast(t.modal.validationError);
return;
}
if (min >= max) {
showToast(t.modal.rangeError);
row.querySelector('.min-input').classList.add('error-shake');
setTimeout(() => row.querySelector('.min-input').classList.remove('error-shake'), 500);
return;
}
if (min < 0 || max > 100 || min > 100 || max < 0) {
showToast(t.toast.invalidScore);
return;
}
newRules.push({ min, max, gp });
}
for (let i = 0; i < newRules.length; i++) {
for (let j = i + 1; j < newRules.length; j++) {
const a = newRules[i];
const b = newRules[j];
if ((a.min <= b.max && a.max >= b.min) || (b.min <= a.max && b.max >= a.min)) {
showToast(t.modal.overlapError);
return;
}
}
}
customScaleData = newRules.sort((a, b) => a.min - b.min);
previousMode = null;
closeCustomScaleModal();
applyModeSettings('custom');
renderGradeScaleCards();
document.getElementById('scaleHeaderText').textContent = `${t.scaleTitle} (${t.modeNames.custom})`;
document.getElementById('gradeScaleContainer').classList.remove('expanded');
const courses = document.querySelectorAll('.course-item');
courses.forEach(course => {
if (course.dataset.confirmed === 'true') {
const id = course.id.split('-')[1];
const score = parseFloat(document.getElementById(`score-${id}`).value);
const newGP = calculateGradePoint(score);
course.dataset.gp = newGP;
const weighted = newGP * parseFloat(course.dataset.credit);
course.dataset.weighted = weighted.toFixed(2);
const actionBtn = document.getElementById(`action-${id}`);
actionBtn.textContent = newGP.toFixed(1);
actionBtn.classList.remove('high', 'mid', 'low');
if (newGP >= 3.0) actionBtn.classList.add('high');
else if (newGP >= 2.0) actionBtn.classList.add('mid');
else actionBtn.classList.add('low');
}
});
showToast(t.toast.customScaleSet);
if (document.getElementById('resultSection').classList.contains('show')) {
calculateGPA();
}
}

function applyModeSettings(mode) {
const t = translations[currentLang];
renderGradeScaleCards();
document.getElementById('scaleHeaderText').textContent = `${t.scaleTitle} (${t.modeNames[mode]})`;
document.getElementById('gradeScaleContainer').classList.remove('expanded');
const courses = document.querySelectorAll('.course-item');
courses.forEach(course => {
if (course.dataset.confirmed === 'true') {
const id = course.id.split('-')[1];
const score = parseFloat(document.getElementById(`score-${id}`).value);
const newGP = calculateGradePoint(score);
course.dataset.gp = newGP;
const weighted = newGP * parseFloat(course.dataset.credit);
course.dataset.weighted = weighted.toFixed(2);
const actionBtn = document.getElementById(`action-${id}`);
actionBtn.textContent = newGP.toFixed(1);
actionBtn.classList.remove('high', 'mid', 'low');
if (newGP >= 3.0) actionBtn.classList.add('high');
else if (newGP >= 2.0) actionBtn.classList.add('mid');
else actionBtn.classList.add('low');
}
});
if (document.getElementById('resultSection').classList.contains('show')) {
calculateGPA();
}
showToast(`${t.toast.modeSwitch} ${t.modeNames[mode]}`);
}

function renderDropdowns() {
const t = translations[currentLang];
const themeDropdown = document.getElementById('themeDropdown');
themeDropdown.innerHTML = themes.map((theme, index) => `
<div class="dropdown-item ${currentTheme === (theme.id === 'default' ? '' : theme.id) ? 'active' : ''}" 
onclick="setTheme('${theme.id}', this)">
${theme.icon} ${t.themes[index]}
</div>
`).join('');
const langDropdown = document.getElementById('langDropdown');
langDropdown.innerHTML = languages.map(lang => `
<div class="dropdown-item ${currentLang === lang.code ? 'active' : ''}" 
onclick="setLanguage('${lang.code}', this)">
${lang.name}
</div>
`).join('');
const modeDropdown = document.getElementById('modeDropdown');
modeDropdown.innerHTML = modes.map((mode, index) => `
<div class="dropdown-item ${currentMode === mode.id ? 'active' : ''}" 
onclick="handleModeSelect('${mode.id}')">
${t.modes[index]}
</div>
`).join('');
}

function handleModeSelect(mode) {
if (mode === 'custom') {
if (currentMode !== 'custom') {
previousMode = currentMode;
}
currentMode = 'custom';
renderDropdowns();
document.getElementById('modeDropdown').classList.remove('show');
openCustomScaleModal();
} else {
currentMode = mode;
renderDropdowns();
document.getElementById('modeDropdown').classList.remove('show');
applyModeSettings(mode);
}
}

function toggleDropdown(id) {
const dropdown = document.getElementById(id);
const allDropdowns = document.querySelectorAll('.dropdown-menu');
allDropdowns.forEach(d => {
if (d.id !== id) d.classList.remove('show');
});
dropdown.classList.toggle('show');
}

function setTheme(theme, element) {
if (theme === 'default') {
document.body.removeAttribute('data-theme');
currentTheme = 'default';
} else {
document.body.setAttribute('data-theme', theme);
currentTheme = theme;
}
renderDropdowns();
document.getElementById('themeDropdown').classList.remove('show');
}

function setLanguage(lang, element) {
currentLang = lang;
renderDropdowns();
document.getElementById('langDropdown').classList.remove('show');
updateLanguage();
}

function updateLanguage() {
const t = translations[currentLang];
document.getElementById('title').textContent = t.title;
document.getElementById('subtitle').textContent = t.subtitle;
document.getElementById('emptyText').textContent = t.empty;
document.getElementById('addBtnText').textContent = t.addCourse;
document.getElementById('calcBtnText').textContent = t.calc;
document.getElementById('resultTitle').textContent = t.resultTitle;
document.getElementById('totalCoursesLabel').textContent = t.totalCourses;
document.getElementById('totalCreditsLabel').textContent = t.totalCredits;
document.getElementById('chartTitle').textContent = t.chartTitle;
document.getElementById('themeBtn').title = t.controls.theme;
document.getElementById('langBtn').title = t.controls.language;
document.getElementById('modeBtn').title = t.controls.mode;
document.getElementById('scaleHeaderText').textContent = `${t.scaleTitle} (${t.modeNames[currentMode]})`;
renderGradeScaleCards();
document.querySelectorAll('.course-item').forEach(course => {
const id = course.id.split('-')[1];
const nameInput = document.getElementById(`name-${id}`);
const scoreInput = document.getElementById(`score-${id}`);
const creditInput = document.getElementById(`credit-${id}`);
if (nameInput) {
nameInput.previousElementSibling.textContent = t.courseName;
if (!course.dataset.confirmed) {
nameInput.placeholder = t.courseNamePlaceholder;
}
}
if (scoreInput) scoreInput.previousElementSibling.textContent = t.score;
if (creditInput) creditInput.previousElementSibling.textContent = t.credit;
const actionBtn = document.getElementById(`action-${id}`);
if (actionBtn && !actionBtn.classList.contains('confirmed')) {
actionBtn.textContent = t.confirm;
}
});
}

document.addEventListener('click', function(e) {
if (!e.target.matches('.control-btn')) {
document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
}
});

function showToast(message) {
const toast = document.getElementById('toast');
toast.textContent = message;
toast.classList.add('show');
setTimeout(() => toast.classList.remove('show'), 2500);
}

function addCourse() {
courseCount++;
const list = document.getElementById('courseList');
const emptyState = document.getElementById('emptyState');
const t = translations[currentLang];
if (emptyState) emptyState.style.display = 'none';
const courseDiv = document.createElement('div');
courseDiv.className = 'course-item';
courseDiv.id = `course-${courseCount}`;
courseDiv.innerHTML = `
<div class="course-number">${courseCount}</div>
<div class="input-group">
<label>${t.courseName}</label>
<input type="text" id="name-${courseCount}" placeholder="${t.courseNamePlaceholder}" required>
</div>
<div class="input-group">
<label>${t.score}</label>
<input type="number" id="score-${courseCount}" min="0" max="100" placeholder="0-100" 
class="no-spinner" onwheel="return false;" required>
</div>
<div class="input-group">
<label>${t.credit}</label>
<input type="number" id="credit-${courseCount}" min="0" step="0.5" placeholder="3.0" 
onwheel="return false;" required>
</div>
<button class="action-btn" id="action-${courseCount}" onclick="confirmCourse(${courseCount})">${t.confirm}</button>
<button class="delete-btn" onclick="deleteCourse(${courseCount})" title="${t.delete}">×</button>
`;
list.appendChild(courseDiv);
setTimeout(() => document.getElementById(`name-${courseCount}`).focus(), 100);
}

function confirmCourse(id) {
const nameInput = document.getElementById(`name-${id}`);
const scoreInput = document.getElementById(`score-${id}`);
const creditInput = document.getElementById(`credit-${id}`);
const actionBtn = document.getElementById(`action-${id}`);
const courseDiv = document.getElementById(`course-${id}`);
const t = translations[currentLang];
const name = nameInput.value.trim();
const score = parseFloat(scoreInput.value);
const credit = parseFloat(creditInput.value);

if (!name) {
nameInput.classList.add('error-shake');
setTimeout(() => nameInput.classList.remove('error-shake'), 400);
showToast(t.toast.noName);
return;
}
if (isNaN(score) || score < 0 || score > 100) {
scoreInput.classList.add('error-shake');
setTimeout(() => scoreInput.classList.remove('error-shake'), 400);
showToast(t.toast.invalidScore);
return;
}
if (isNaN(credit) || credit < 0) {
creditInput.classList.add('error-shake');
setTimeout(() => creditInput.classList.remove('error-shake'), 400);
showToast(t.toast.invalidCredit);
return;
}

const gp = calculateGradePoint(score);
actionBtn.textContent = gp.toFixed(1);
actionBtn.classList.add('confirmed');
actionBtn.disabled = true;
actionBtn.onclick = null;
actionBtn.classList.remove('high', 'mid', 'low');
if (gp >= 3.0) actionBtn.classList.add('high');
else if (gp >= 2.0) actionBtn.classList.add('mid');
else actionBtn.classList.add('low');

nameInput.readOnly = true;
scoreInput.readOnly = true;
creditInput.readOnly = true;
courseDiv.classList.add('confirmed');
courseDiv.dataset.confirmed = 'true';
courseDiv.dataset.name = name;
courseDiv.dataset.gp = gp;
courseDiv.dataset.credit = credit;
courseDiv.dataset.weighted = (gp * credit).toFixed(2);
showToast(t.toast.confirmed);
}

function deleteCourse(id) {
const course = document.getElementById(`course-${id}`);
course.remove();
renumberCourses();
checkEmptyState();
}

function renumberCourses() {
const courses = document.querySelectorAll('.course-item');
courses.forEach((course, index) => {
course.querySelector('.course-number').textContent = index + 1;
courseCount = index + 1;
});
}

function checkEmptyState() {
const items = document.querySelectorAll('.course-item');
const emptyState = document.getElementById('emptyState');
if (items.length === 0 && emptyState) {
emptyState.style.display = 'block';
document.getElementById('resultSection').classList.remove('show');
document.getElementById('chartSection').classList.remove('show');
courseCount = 0;
}
}

function drawChart(courseData, totalWeighted) {
const canvas = document.getElementById('contributionChart');
const ctx = canvas.getContext('2d');
const dpr = window.devicePixelRatio || 1;
const rect = canvas.getBoundingClientRect();
canvas.width = rect.width * dpr;
canvas.height = rect.height * dpr;
ctx.scale(dpr, dpr);

const width = rect.width, height = rect.height;
const centerX = width / 2, centerY = height / 2;
const radius = Math.min(width, height) / 2 - 30;
const innerRadius = radius * 0.55;

ctx.clearRect(0, 0, width, height);
let currentAngle = -Math.PI / 2;
const t = translations[currentLang];
courseChartData = [];

courseData.forEach((course, index) => {
const contribution = course.weighted / totalWeighted;
const sliceAngle = contribution * 2 * Math.PI;
const endAngle = currentAngle + sliceAngle;
const color = colors[index % colors.length];

courseChartData.push({
startAngle: currentAngle,
endAngle: endAngle,
course: course,
contribution: contribution,
color: color
});

ctx.beginPath();
ctx.arc(centerX, centerY, radius, currentAngle, endAngle);
ctx.arc(centerX, centerY, innerRadius, endAngle, currentAngle, true);
ctx.closePath();
ctx.fillStyle = color;
ctx.fill();
ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--card-bg').trim() || '#ffffff';
ctx.lineWidth = 2;
ctx.stroke();

currentAngle = endAngle;
});

ctx.beginPath();
ctx.arc(centerX, centerY, innerRadius - 4, 0, 2 * Math.PI);
ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card-bg').trim() || '#ffffff';
ctx.fill();

ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
ctx.font = 'bold 13px sans-serif';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.fillText(t.chart.contribution, centerX, centerY - 8);
ctx.font = '11px sans-serif';
ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
ctx.fillText(t.chart.weighted, centerX, centerY + 8);

const legendDiv = document.getElementById('chartLegend');
legendDiv.innerHTML = '';
courseData.forEach((course, index) => {
const contribution = (course.weighted / totalWeighted * 100).toFixed(1);
const item = document.createElement('div');
item.className = 'legend-item';
item.innerHTML = `<div class="legend-color" style="background: ${colors[index % colors.length]}"></div>
<span>${course.name} (${contribution}%)</span>`;
legendDiv.appendChild(item);
});
}

function handleChartClick(e) {
const canvas = document.getElementById('contributionChart');
const rect = canvas.getBoundingClientRect();
const x = e.offsetX;
const y = e.offsetY;
const centerX = rect.width / 2;
const centerY = rect.height / 2;
const radius = Math.min(centerX, centerY) - 30;
const innerRadius = radius * 0.55;

const dx = x - centerX;
const dy = y - centerY;
const distance = Math.sqrt(dx * dx + dy * dy);

if (distance < innerRadius || distance > radius) {
document.getElementById('chartTooltip').classList.remove('show');
return;
}

let angle = Math.atan2(dy, dx);
angle += Math.PI / 2;
if (angle < 0) angle += 2 * Math.PI;

const clickedSlice = courseChartData.find(slice => {
let start = slice.startAngle + Math.PI / 2;
let end = slice.endAngle + Math.PI / 2;
if (start < 0) start += 2 * Math.PI;
if (end < 0) end += 2 * Math.PI;
if (start > end) return angle >= start || angle <= end;
return angle >= start && angle <= end;
});

if (clickedSlice) {
const tooltip = document.getElementById('chartTooltip');
const t = translations[currentLang];
tooltip.innerHTML = `
<strong style="color: ${clickedSlice.color}">${clickedSlice.course.name}</strong><br>
${t.chart.gp}: ${clickedSlice.course.gp.toFixed(1)} | 
${t.chart.credits}: ${clickedSlice.course.credit}<br>
${(clickedSlice.contribution * 100).toFixed(1)}%
`;
tooltip.style.left = (x + 10) + 'px';
tooltip.style.top = (y - 10) + 'px';
tooltip.classList.add('show');
setTimeout(() => tooltip.classList.remove('show'), 2000);
}
}

document.getElementById('chartWrapper').addEventListener('click', handleChartClick);

function calculateGPA() {
const courses = document.querySelectorAll('.course-item');
const t = translations[currentLang];
if (courses.length === 0) {
showToast(t.toast.noCourse);
return;
}

let courseData = [];
let hasUnconfirmed = false;
courses.forEach(course => {
if (course.dataset.confirmed !== 'true') {
hasUnconfirmed = true;
course.classList.add('error-shake');
setTimeout(() => course.classList.remove('error-shake'), 400);
} else {
courseData.push({
name: course.dataset.name,
gp: parseFloat(course.dataset.gp),
credit: parseFloat(course.dataset.credit),
weighted: parseFloat(course.dataset.weighted)
});
}
});

if (hasUnconfirmed) {
showToast(t.toast.confirmAll);
return;
}

let totalWeighted = 0, totalCredits = 0;
courseData.forEach(c => {
totalWeighted += c.weighted;
totalCredits += c.credit;
});

if (totalCredits === 0) {
showToast(t.toast.zeroCredit);
return;
}

const gpa = totalWeighted / totalCredits;
// 修改：保留五位小数
document.getElementById('gpaValue').textContent = gpa.toFixed(5);
document.getElementById('totalCourses').textContent = courseData.length;
document.getElementById('totalCredits').textContent = totalCredits.toFixed(1);
document.getElementById('resultSection').classList.add('show');
document.getElementById('chartSection').classList.add('show');
drawChart(courseData, totalWeighted);

let message = gpa >= 3.7 ? t.toast.excellent : 
gpa >= 3.0 ? t.toast.good : 
gpa >= 2.0 ? t.toast.average : t.toast.improve;
showToast(message);
}

window.onload = function() {
renderGradeScaleCards();
renderDropdowns();
const t = translations[currentLang];
document.getElementById('scaleHeaderText').textContent = `${t.scaleTitle} (${t.modeNames[currentMode]})`;
updateLanguage();
addCourse();
};

document.addEventListener('keypress', function(e) {
if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
e.preventDefault();
const currentId = e.target.id.split('-')[1];
const currentField = e.target.id.split('-')[0];
if (currentField === 'name') document.getElementById(`score-${currentId}`).focus();
else if (currentField === 'score') document.getElementById(`credit-${currentId}`).focus();
else if (currentField === 'credit') confirmCourse(currentId);
}
});

window.addEventListener('resize', function() {
if (document.getElementById('chartSection').classList.contains('show')) {
const courses = document.querySelectorAll('.course-item');
let courseData = [], totalWeighted = 0;
courses.forEach(course => {
if (course.dataset.confirmed === 'true') {
const data = {
name: course.dataset.name,
gp: parseFloat(course.dataset.gp),
credit: parseFloat(course.dataset.credit),
weighted: parseFloat(course.dataset.weighted)
};
courseData.push(data);
totalWeighted += data.weighted;
}
});
if (courseData.length > 0) drawChart(courseData, totalWeighted);
}
});
</script>
</body>
</html>
